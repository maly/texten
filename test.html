<meta charset = utf-8>
<script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
<link rel="stylesheet" href="css/stylesheet.css">

<style>
 body, input {font-family: 'hologramregular';line-height: 1.4em}
 body {background-color: #333;color:#eee;}
 #display{
 	height:400px;
 }
</style>

<canvas width="640px" height="480px" id="canvas"></canvas>


<script>
var texth = 24;
var textw = 10;
var ctx = document.getElementById('canvas').getContext('2d');
  ctx.font= '20px hologramregular';
  ctx.fillStyle = '#eee';
  ctx.textBaseline="top"; 

var printAt = function(text,x,y){
	ctx.clearRect(x*textw,y*texth,text.length*textw,texth);
	ctx.fillText(text,x*textw,y*texth);
}

var clearRect = function(x,y,w,h) {
	ctx.clearRect(x*textw,y*texth,w*textw,h*texth);
}

var cline = 0;
var maxline = 20;

var printLine = function(text){
	printAt(text,0,cline);
	cline++;
	if (cline==maxline) scrollUp();
}

var printSameLine = function(text){
	ctx.fillStyle = '#ee4';
	printAt(text,0,cline);
	ctx.fillStyle = '#eee';
	//cline++;
	//if (cline==maxline) scrollUp();
}

var printText = function(text){
	var slova = text.split(" ");
	var out = [];
	while (slova.length) {
		out.push(slova.shift());
		var w = ctx.measureText(out.join(" ")).width;
		if (w>640) {
			//jsme p≈ôes
			slova.unshift(out.pop());
			printLine(out.join(" "));
			out=[];
		}
	}
	if (out.length) {
		printLine(out.join(" "));
	}
}

var printTextRed = function(text) {
	ctx.fillStyle = '#e44';
	printText(text);
	ctx.fillStyle = '#eee';
}

var scrollUp = function() {
	var myImageData = ctx.getImageData(0,texth,640,480-texth);
	ctx.clearRect(0,480-texth,640,texth);
	ctx.putImageData(myImageData, 0,0);
	cline--;
}

</script>

<script src="commandCompiler.js"></script>

<script src="bones.js"></script>
<script src="demo.js"></script>

<script>

var t = new texten(g);

var out = function(text){
	//console.log(text);
	printText(text);
}

t.setPrint(out);

var changeRoom = function() {
	//$("#display").html("");
	t.simpleRoom();
}

var doCommand = function(c) {
	console.log(c);
	var hey = t.parseAndDo(c);
	console.log("HEY",hey);
	if (!hey) return false;
	if (hey == "CHANGE ROOM") changeRoom();
	if (typeof hey == "object") {
		printTextRed(hey[0]);
	}

	key(0);
	return false;
}

$(window).bind("load", function(){

	changeRoom();
	key(0);
	
});

/////editor

var eline = "> ";
var key = function(k) {
	if (k==13) {
		printLine(eline+" ");
		doCommand(eline.substr(2).trim());
		eline = "> ";
		return;
	}
	else if (k==8) {
		if (eline.length>2) {
			eline=eline.substr(0,eline.length-1);
			printSameLine(eline+"_ ");
		}
	} else if (!k) {
		eline = "> ";
		printSameLine(eline+"_ ");
	} else {eline += String.fromCharCode(k);}

	printSameLine(eline+"_");
}

//-----
$("body").bind("keydown",
	function (e){
		if (e.keyCode==8) {
			e.preventDefault();
			key(8);
			return e;}
		return e;
	}
);

$("body").bind("keypress",
	function (e){
		e.preventDefault();
		key(e.charCode);
		return false;
	}
);


</script>